import{jQuery as $}from"../jQuery/jquery3.4.1.js";import{L}from"../Leaflet/importer.js";import{K}from"../K.js";import{createMarker}from"./create-marker.js";import{empty,polyHoverAnimation,toCorrectType,sortObjByKeys,switchLayerGroups,toggleHideIcons,showHideLayers,showHideCategory,showHideAllLayers,setGridRotate,editIconMessage}from"./misc.js";import{drawEventCreated}from"../extensions/L.Draw.Extended.js";import{keypressEvent}from"./shortcut.js";export default function pageLoad(){K.loaded=!1,K.cycle.reset(),K.group.draw.clearLayers(),"true"==K.urlParam("noIcon")&&K.local("hideIcon",!0),"true"==K.urlParam("clean")&&K.local("cleanMenu",!0),K.local("hideIcon")||$("#survival-logo").fadeIn(500),K.local("cleanMenu")&&($(".side-menu-toggle.login").hide(0),$(".side-menu-toggle.filters").hide(0),$(".side-menu-toggle.full").hide(0),$(".side-menu-toggle.changes").hide(0),$(".side-menu-toggle.todo").hide(0),$(".side-menu-toggle.gear").hide(0),$(".side-menu-toggle.language").hide(0),$(".side-menu-toggle.shorts").hide(0),$(".leaflet-control-attribution.leaflet-control").hide(0),$("#logo").hide(0)),"true"==K.urlParam("overwolf")&&($(".side-menu-toggle.full").hide(0),$(".side-menu-toggle.changes").hide(0),$(".side-menu-toggle.todo").hide(0),$(".side-menu-toggle.language").hide(0),$(".side-menu-toggle.shorts").hide(0),$(".leaflet-control-attribution.leaflet-control").hide(0),$("#alert").hide(0),$("#logo").hide(0),$("#side-bar .side-menu-toggle.gear").css("top","170px")),$.ajax({url:"php/get_markers.php"}).done(function(e){K.each($.parseJSON(e),function(e,t){K.settings.main.iconUrl.values[t]={shape:[]}})}),K.checkLogin(()=>{!K.user.donate&&!K.urlParam("overwolf")&&$("#alert").show(),K.user.donate&&$("#alert").hide(),$("#message").removeClass("master");let e=$("#side-bar .shorts .side-content");if(e.html(""),$(".side-menu-toggle.shorts").hide(),K.each(K.bar.b,function(e,t){empty(t)}),empty(K.drawControl),$("document").off("keypress"),$("#side-bar a.login").removeClass("out"),K.user.type){$("#side-bar a.login").addClass("out"),$("#message").addClass("master"),!K.urlParam("overwolf")&&$(".side-menu-toggle.shorts").show();let t=function(e,t){return`<div class="item">\n                    <div>${e}</div>\n                    <div class="grey">-</div>\n                    <span>${t.replace(" Survival","")}</span>\n                </div>`};e.append('<span class="title">Shortcuts</span>'),K.each(K.shortcuts,function(a,o){e.append(`<span class="title sub">${a.space()}</span>`),K.each(o,function(a,o){e.append(t(a,o.space()))})}),e.append(K.credits),K.bar.b.power=L.control.button({text:"",container:"power",title:"Enable/disable tools",css:"power",clickFn:function(){K.bar.b.power._click()}}).addTo(K.myMap),K.extend(K.bar.b.power,{enabled:function(){return!$(this._button).hasClass("enabled")},_click:function(){let e=$(this._button),t=$(".leaflet-top.leaflet-left").children().not(".power").find("a");this.enabled()||K.check.doOnce?(e.addClass("enabled"),K.each(K.bar.draw,function(e,t){t.disabler()}),$("#marker-tools, .group-switch, #settings-menu").remove(),K.bar.b.group.disable(),K.bar.b.tools.disable(),switchLayerGroups(!0),$(t.get().reverse()).each(function(e,t){setTimeout(function(){$(t).css("transform","translateX(-50px)")},40*e)})):(t.each(function(e,t){setTimeout(function(){$(t).css("transform","translateX(0px)")},40*e)}),e.removeClass("enabled"),K.each(K.bar.draw,function(e,t){t.enabler()}),K.bar.b.group.enable(),K.bar.b.tools.enable(),switchLayerGroups()),K.local("powered",this.enabled()),K.check.doOnce=!1}}),K.bar.b.save=L.control.button().addTo(K.myMap).disable(),K.bar.b.cancel=L.control.button({text:"",title:"Discard all unsaved changes",css:"cancel",clickFn:function(){$("<div />",{class:"screen-blank",html:$("<div />",{class:"confirm",html:$("<div />",{class:"message",html:"Are you sure you want to discard all changes?"})})}).appendTo("body"),$("<a />",{class:"button no",title:"Cancel",html:"Cancel"}).appendTo(".confirm").on("click",function(){$(".screen-blank").remove()}),$("<a />",{class:"button yes",title:"Discard",html:"Discard"}).appendTo(".confirm").on("click",function(){$(".screen-blank").remove(),K.save.clear(),pageLoad()})}}).addTo(K.myMap).disable(),K.bar.b.group=L.control.button({text:"",title:"Switch editable layers",css:"group",clickFn:function(){if($(".group-switch").length)return void $(".group-switch").remove();$("body").append('<div class="leaflet-menu group-switch"></div>');let e=document.getElementsByClassName("group-switch")[0];L.DomEvent.disableClickPropagation(e),L.DomEvent.on(e,"mousewheel",L.DomEvent.stopPropagation),K.each(sortObjByKeys(K.map.type[K.mode]),function(e,t){$(".leaflet-menu").append(`<span class="leaflet-menu-item title">${e.space()}</span>`),K.each(sortObjByKeys(t),function(e){$(".leaflet-menu").append(`<a class="leaflet-menu-item switch-active-group \n                                ${K.map.active[e]?" active":""}" type="${e}">${e.space().replace(" Of "," of ")}</a>`)})}),$(".switch-active-group").on("click",function(){let e=$(this).attr("type");$(this).toggleClass("active"),K.map.active[e]=!K.map.active[e],switchLayerGroups()})}}).addTo(K.myMap),K.bar.b.grid=L.control.button({text:"",title:"Grid modifier tools",css:"grid",clickFn:function(){let e=arguments[0]._button;if($("#slider-box").length)return void $("#slider-box").remove();let t=["rotate","x-pos","y-pos"];$(e).after('<div id="slider-box" class="slider-panel"></div>'),K.each(t,function(e,t){$("#slider-box").append(`<div class="leaflet-menu-slider">\n                            <div id="slider-${t}" class="slider-class ${t}">\n                                <div class="handle-${t} ui-slider-handle"></div>\n                            </div>\n                        </div>`),$("#slider-"+t).slider({min:"rotate"==t?-45:-100,max:"rotate"==t?45:100,step:"rotate"==t?.5:1,value:K.local(`grid-${t}`)||0,create:function(){let e=$(this).slider("value");$(".handle-"+t).text("rotate"==t?e+" deg":"x-pos"==t?"X: "+e:"Y: "+e)},slide:function(e,a){$(".handle-"+t).text("rotate"==t?a.value+" deg":"x-pos"==t?"X: "+a.value:"Y: "+a.value),K.local("grid-"+t,a.value),setGridRotate()},change:function(e,a){$(".handle-"+t).text("rotate"==t?a.value+" deg":"x-pos"==t?"X: "+a.value:"Y: "+a.value),K.local("grid-"+t,a.value),setGridRotate()}})}),$("#slider-box").append('<div class="slider-resets"></div>'),K.each(t,function(e,t){$(".slider-resets").append(`<a class="slider-button reset-${t}">Reset ${t.firstToUpper()}</a>`),$(".slider-button.reset-"+t).on("click",function(){$("#slider-"+t).slider("value",0)})}),$(".slider-resets").append('<a class="slider-button reset-all">Reset All</a>'),$(".slider-button.reset-all").on("click",function(){$(".slider-class").slider("value",0)});let a=L.DomUtil.get("slider-box");L.DomEvent.disableClickPropagation(a),L.DomEvent.on(a,"mousewheel",L.DomEvent.stopPropagation)}}).addTo(K.myMap).disable(),K.bar.b.tools=L.control.button({text:"",title:"Toggle marker tool panel",css:"tools",clickFn:K.tool.marker.show}).addTo(K.myMap),K.updateMarker(),K.myMap.addControl(K.drawControl).on("draw:created",drawEventCreated),K.bar.draw.Polygon=K.drawControl._toolbars.draw._modes.polygon.handler,K.bar.draw.Polyline=K.drawControl._toolbars.draw._modes.polyline.handler,K.bar.draw.Rectangle=K.drawControl._toolbars.draw._modes.rectangle.handler,K.bar.draw.Marker=K.drawControl._toolbars.draw._modes.marker.handler,K.bar.draw.Circle=K.drawControl._toolbars.draw._modes.circle.handler,K.bar.edit.Edit=K.drawControl._toolbars.edit._modes.edit.handler,K.bar.edit.Remove=K.drawControl._toolbars.edit._modes.remove.handler,$(document).off("keypress"),$(document).on("keypress",keypressEvent),K.myMap.on("draw:editstart",function(){polyHoverAnimation(!0),$("#settings-menu, .group-switch, #marker-tools").remove(),K.bar.b.power.disable(),K.bar.b.group.disable(),K.bar.b.save.disable(),K.bar.b.tools.disable(),K.myMap.addLayer(K.group.draw).addLayer(K.grid.overlay),K.bar.b.grid.enable(),setGridRotate(),K.bar.edit.Remove.disabler(),K.each(K.bar.draw,function(e,t){t.disabler()}),K.check.editing=!0,editIconMessage(),K.group.draw.eachLayer(function(e){e.dragging.enabled()&&(e.dragging.disable(),e.editing.wasDragging=!0)})}),K.myMap.on("draw:edited",function(e){e.layers.eachLayer(function(e){e.saved(!1)})}),K.myMap.on("draw:editstop",function(){K.bar.b.power.enable(),K.bar.b.group.enable(),K.bar.b.tools.enable(),K.save.check(),K.myMap.removeLayer(K.grid.overlay),K.bar.b.grid.disable(),$("#slider-box").remove(),K.bar.edit.Remove.enabler(),K.each(K.bar.draw,function(e,t){t.enabler()}),K.check.editing=!1,polyHoverAnimation(),K.myMap.panBy([0,0]),K.group.draw.eachLayer(function(e){e.editing.wasDragging&&(e.dragging.enable(),e.editing.wasDragging=!1)})}),K.myMap.on("draw:deletestart",function(){K.check.deleting=!0,K.each(K.bar.b,function(e,t){t.disable()}),K.bar.edit.Edit.disabler(),K.each(K.bar.draw,function(e,t){t.disabler()}),K.myMap.addLayer(K.group.draw),setGridRotate()}),K.myMap.on("draw:deleted",function(e){K.each(e.layers._layers,function(e,t){K.group.draw.removeLayer(e),K.save.delete(t),K.map.type.remove(t.options.type)})}),K.myMap.on("draw:deletestop",function(){K.check.deleting=!1,K.bar.b.power.enable(),K.bar.b.group.enable(),K.save.check(),K.bar.edit.Edit.enabler(),K.each(K.bar.draw,function(e,t){t.enabler()}),K.myMap.panBy([0,0])}),K.myMap.on("draw:drawstop",function(){K.user.type>3||K.msg.show({msg:"Remember, you may have to zoom in to see the layers you create!",time:2500})})}K.user.type&&K.check.doOnce&&K.bar.b.power._onClick();$.ajax({type:"POST",url:"php/file_exists.php",data:{data:K.user.name}}).done(function(e){e=$.parseJSON(e),K.userPath=e?"data/"+K.user.name+"/geoJSON.json":"data/empty.json",$.ajax({type:"POST",url:"php/file_date.php",data:{path:K.userPath}}).done(function(e){e=$.parseJSON(e),$.getJSON(`${K.userPath}?v=${e.date}`,function(e){$.ajax({type:"POST",url:"php/file_date.php",data:{path:"data/geoJSON.json"}}).done(function(t){t=$.parseJSON(t),$.getJSON(`data/geoJSON.json?v=${t.date}`,function(t){K.myMap.invalidateSize(),K.each(K.group.feature,function(e,t){K.each(t,function(e,t){t.clearLayers(),K.myMap.removeLayer(t)})}),K.modes.clear(),K.map.type.counts={},K.complete.layers=[],K.timed.layers=[];const a=K.local("unsaved")||{features:{},settings:{}};K.each(a.features,function(e,t){t.unsaved=!0}),K.each(a.settings,function(e,t){t.unsaved=!0}),e.features&&K.extend(t.features,e.features),K.extend(t.features,a.features),K.layer=K.extend({},t.settings,e.settings||{},a.settings),K.each(K.layer,function(e,t){K.each(t.o,function(t,a){K.layer[e].o[t]=toCorrectType(t,a)})}),K.each(t.features,function(e,t){!function(e,t){let a,o=K.extend(!0,{},K.layer[e.t]||{}),s=e.g,r=K.extend({},o.o||{},e.o||{},{creator:e.c,id:t,shape:s.t}),n=K.extend({},o.p||{},e.p||{});if((e.p||{}).content&&delete n.list,(e.p||{}).list&&delete n.content,!r)return;if(K.each(r.mode,function(e,t){"array"===K.type(t)&&(r.mode[e]={})}),r.type||(r.type=""),r.type&&!K.has(r.type,K.map.group[r.group])&&K.map.group[r.group].push(r.type),r.type&&r.mode&&r.shape){let e=!1;if(K.user.type<1?r.type.contains("Complete")||"Error"==r.type||(e=!0):K.user.type<=3?r.type.contains(K.user.name)?e=!0:r.type.contains("Complete")||"Error"==r.type||(e=!0):K.user.type>=4&&(e=!0),e){let e=r.fillColor;"marker"==r.shape&&(e=r.iconUrl),"polyline"==r.shape&&(e=r.color),K.map.type.counts[r.type]?K.map.type.counts[r.type]++:K.map.type.counts[r.type]=1,K.each(K.modes.get,function(t,a){let o=r.category||"Default",s=K.map.type[a];s[o]||(s[o]={}),K.in(a,r.mode)&&(s[o][r.type]||(s[o][r.type]=[]),K.has(e,s[o][r.type])||(s[o][r.type].push(e),K.has(r.shape,["polygon","circle","rectangle"])&&s[o][r.type].push(r.color)))})}}for(o in r.mode in K.map.mode||(K.map.mode[r.mode]=[]),r.mode&&r.type&&!K.has(r.type,K.map.mode[r.mode])&&K.map.mode[r.mode].push(r.type),r)r[o]=toCorrectType(o,r[o]),"className"==o&&(r[o]=K.stripClasses(r[o])),K.settings.add(o,r[o],r.shape);let l=n.className?n.className:"";if(l&&!K.classRemoval.contains(l)&&(K.classRemoval=`${K.classRemoval.trim()} ${l}`),!K.classRemoval.contains(r.group)&&(K.classRemoval=`${K.classRemoval.trim()} ${r.group}`),"marker"==r.shape&&r.type){let e={o:K.extend({},r,{className:(r.className||"").replace(/\w+ground/g,"").trim()}),p:n||{}};K.each(K.modes.get,function(t,a){let o=K.tool.marker.layers[a];a in r.mode&&(r.category in o||(o[r.category]={}),r.type in o[r.category]||(o[r.category][r.type]=e),K.icons[r.type.space()]=e.o.iconUrl)})}if("marker"!=s.t){let e=K.extend(r,{pane:r.pane||("poly-hover"==r.className?"zonePane":"overlayPane")});"circle"==s.t&&(e.radius=s.r),a=L[s.t](s.c,r)}else"marker"==s.t&&(a=createMarker(K.extend(r,{latlng:s.c})));if(5==K.user.type&&n.content&&"poly-info"!=n.className&&n.content.bMatch("<p")){console.log(t,n);let e=$("<div />").append(n.content),o={title:!1,subs:[]};e.children().each(function(){if("P"==$(this).prop("nodeName")&&""!=$(this).text()){let e={};e.value=$(this).text(),"HR"==$(this).next().prop("nodeName")&&(e.line=!0),$(this).hasClass("desc")&&(e.color=!0),$(this).hasClass("note")&&(e.note=!0),o.subs.push(e)}$(this).remove()}),o.title=$(e).text().trim(),delete n.content,n.list=o,a.saved(!1)}(n&&K.in("content",n)||K.in("list",n))&&(a.bindPopup(n),K.user.type&&K.settings.add("className",n.className,r.shape,!0)),K.user.type&&(K.user.type>=4||r.creator.toLowerCase()==K.user.name.toLowerCase())&&a.on("click",K.tool.layer.show),a.on("contextmenu",function(e){K.contextMenu.build(e,this)});let i=!1;K.user.type<1?r.type.contains("Complete")||"Error"==r.type||(i=!0):K.user.type<=3?r.type.contains(K.user.name)?i=!0:r.type.contains("Complete")||"Error"==r.type||(i=!0):K.user.type>=4&&(i=!0),i&&K.group.addLayer(a),a.markComplete(),e.unsaved&&a.saved(!1)}(t,e)})}).done(function(){!function(){K.myMap.panBy([0,0]),K.user.type&&switchLayerGroups(),K.completeHidden=K.local("completeHidden")||!1;let e="#side-bar .filters .side-content";$(e).html(""),$(e).append(`<a class="hide-all" title="Show/Hide all!"></a>\n                <span class="title">Filters</span>\n                <a class="hide-complete${K.completeHidden?' hidden">Show':'">Hide'} Complete</a>`);const t=sortObjByKeys(K.map.type[K.mode]);if(K.filters=K.local("filters")||{},K.each(t,function(t,a){K.length(a)&&(a=sortObjByKeys(a),$(e).append(`<div class="sub title buttons">\n                        <a class="collapse">\n                            <span class="text">${t.firstToUpper()}</span>\n                            <span class="control icon" title="Collapse/Expand ${t}"></span>\n                        </a>\n                        <a class="control hide-some" category="${t}" title="Show/Hide all ${t}"></a>\n                    </div>`),K.each(a,function(a,o){let s=K.filters[a]||!1,r=$("<a />",{class:"side-bar-button "+(s?"inactive":""),set:t,label:a,html:$("<span />",{html:a.space().replace(/Dz/,"DZ").replace(/ (Survival|Complete)/,"").replace(" Of "," of ")})}).appendTo(e);if($("<span />",{html:"[ x"+K.map.type.counts[a]+" ]",class:"quantity"}).appendTo(r),o[0].contains(".svg")){let e=o[Math.floor(Math.random()*o.length)];"MainMission"==a&&(e="images/marker-mission.svg"),"SideMission"==a&&(e="images/marker-mission-side.svg"),$("<img />",{src:e}).prependTo(r)}else"polyline"==t?$("<div />",{class:"polyline"}).css({backgroundColor:o[0]}).prependTo(r):$("<div />",{class:"polygon"}).css({borderColor:o[1],backgroundColor:o[0]}).prependTo(r);s&&showHideLayers(t,a,!0)}))}),$("#side-bar .side-bar-button").off("click").on("click",function(){$(this).toggleClass("inactive"),toggleHideIcons();let e=$(this).attr("label"),t=$(this).hasClass("inactive");K.filters=K.local("filters")||{},K.filters[e]=t,K.local("filters",K.filters),showHideLayers($(this).attr("set"),e,t)}),$("#side-bar .hide-all").off("click").on("click",function(){showHideAllLayers(!$(this).hasClass("hidden")),toggleHideIcons()}),$("#side-bar .hide-some").off("click").on("click",function(){showHideCategory($(this).attr("category"),!$(this).hasClass("hidden")),toggleHideIcons()}),$("#side-bar .hide-complete").off("click").on("click",function(){K.completeHidden?($(this).removeClass("hidden").text("Hide Complete"),K.completeHidden=!1):($(this).addClass("hidden").text("Show Complete"),K.completeHidden=!0),K.local("completeHidden",K.completeHidden),K.complete.showHide()}),K.complete.showHide(),toggleHideIcons(),$("#side-bar .collapse").off("click").on("click",function(){let e=$(".icon",this),t=$(this).parent().nextUntil(".sub.title");e.hasClass("hidden")?(t.each(function(){$(this).show(400)}),e.removeClass("hidden")):(t.each(function(){$(this).hide(400)}),e.addClass("hidden"))}),$(e).append(K.credits),K.local("sideBar")&&!K.local("cleanMenu")){let e=K.local("sideMenu");$("#side-bar, #side-bar ."+e).addClass("active "+e)}polyHoverAnimation(),$('.search [title!=""]').qtip({position:{viewport:$("#mapid"),my:"top right",at:"bottom center"},style:{classes:"tooltip-style"},show:{delay:250,solo:!0},hide:{event:"click mouseleave"}}),$("body").on("mouseover",'[title!=""]',function(){$(this).attr("title")&&($(this).removeAttr("oldtitle"),$(this).qtip("destroy",!0),$(this).qtip({position:{viewport:$("#mapid"),my:"left center",at:"right center"},style:{classes:"tooltip-style"},show:{delay:250,solo:!0},hide:{event:"click mouseleave"}}),$(this).qtip("toggle",!0))}),setTimeout(function(){$("#survival-logo, .loader-back").fadeOut(1e3)},1e3),$(".paypalBtn").off("click").on("click",function(){$("#side-bar .filters .paypalBtn").closest("form").submit()})}(),K.setWorldTier(),K.loaded=!0,setTimeout(()=>K.cycle.start(),1e3),K.search.attach(),K.performURITasks()})})})})})})}
//# sourceMappingURL=page-load.js.map