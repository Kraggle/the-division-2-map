import{jQuery as $}from"../jQuery/jquery3.4.1.js";import{L}from"../Leaflet/importer.js";import{K,classesToArray,stripAndCollapse}from"../K.js";import{createGeoJSON}from"../functions/to-geo-json.js";import{createIcon}from"../functions/create-marker.js";L.Map.include({openPopup:function(t,e,i){return t instanceof L.Popup||(t=new L.Popup(i).setContent(t)),e&&t.setLatLng(e),this.hasLayer(t)?this:"marker"!=t.options.type?(this._detail&&this._detail.options.autoClose&&this.closeDetail(),this._detail=t,this.addLayer(t)):(this._popup&&this._popup.options.autoClose&&this.closePopup(),this._popup=t,this.addLayer(t))},closePopup:function(t){return t&&t!==this._popup||(t=this._popup,this._popup=null),t&&this.removeLayer(t),this},closeDetail:function(t){return t&&t!==this._detail||(t=this._detail,this._detail=null),t&&this.removeLayer(t),this}}),L.Layer.include({openPopup:function(t,e){if(t instanceof L.Layer||(e=t,t=this),t instanceof L.FeatureGroup)for(let e in this._layers){t=this._layers[e];break}if(!this._popup._content)return this;let i=this.getSetting("content",!0)||this.getSetting("list",!0);return this._popup.setContent(i),e||(e=t.getCenter?t.getCenter():t.getLatLng()),this._popup._content?(this._popup&&this._map&&(this._popup._source=t,this._popup.update(),this._map.openPopup(this._popup,e)),this):this},bindPopup:function(){const t=arguments;let e=t[0],i=t[1]||{};"object"===K.type(t[0])&&(e=(i=t[0]).content),this.popup=i,e=this.getSetting("content",!0);let s={className:this.getSetting("className",!0),pane:"marker"==this.options.shape?"popupPane":"messagePane",list:this.getSetting("list",!0)||{},offset:L.point(-24,42),closeButton:!1,autoPan:!1,minWidth:15,maxWidth:300,type:this.options.shape};return e||K.empty(s.list)||(e=this.convertContent(s)),e?(e=e.bMatch(/^\$/)?K.popupContent[e]:e,this._popup=new L.Popup(s,this),this._popup.setContent(e),this._popupHandlersAdded||(this.on({click:this._openPopup,remove:this.closePopup,move:this._movePopup}),this.on("mouseover click focus",this._openPopup),!K.keepPopupsOpen&&"marker"==this.options.shape&&this.on("mouseout blur",this.closePopup),this._popupHandlersAdded=!0),this):this},convertContent:function(t){let e,i,s=t.list,o="";return s.title&&(o+=s.title),K.each(s.subs,function(t,e){e.value&&(o+=`<p class="${e.color?"desc":""} ${e.note?"note":""}">\n                    ${K.in(e.value.toLowerCase(),K.svg)?K.svg[e.value.toLowerCase()]:""}${e.value}\n                </p>${e.line?"<hr>":""}`)}),s.list&&s.list[0]&&s.list[0].item&&(s.list.sort(function(t,e){return t.item<e.item?-1:t.item>e.item?1:0}),o+="<ul>",K.each(s.list,function(t,s){if(!s)return!0;i=K.icons[s.item],o+=`<li>${e=`<img${i?` src="${i}"`:""}>`}<span>${s.item}</span><span class="qty">${s.qty>1?"(x"+s.qty+")":""}</span></li>`}),o+="</ul>"),o},closePopup:function(){return this._popup&&this._popup._content&&this._popup._close(),this}}),L.Layer.include({toggleCompleted:function(){if(!this.getSetting("complete"))return;let t=this.options.prerequisites,e=!0;t&&K.each(t,function(t,i){!K.complete.is(i)&&(e=!1)}),e&&K.complete.toggle(this),e&&this.markComplete(),!e&&K.msg.show({msg:"Prerequisites are not met for this to be completed!",time:4e3})},setCompleted:function(t){this.getSetting("complete")&&(K.complete.set(t,this),this.markComplete())},markComplete:function(){if(!this.getSetting("complete"))return;let t=this.complete=K.complete.is(this);if(!this.init&&!t)return void(this.init=!0);this.init=!0,this.options.time&&t&&(K.complete.time(this)?K.timed.add(this):(K.complete.set(!1,this),K.timed.remove(this.options.id),t=this.complete=K.complete.is(this))),"marker"===this.options.shape?this.updateIcon():this.options.onComplete&&this.updateStyle(),this.options.link&&K.each(this.getLinked(),function(){this.complete!=t&&this.setCompleted(t)}),t?K.complete.add(this):K.complete.remove(this.options.id),K.complete.showHide(),K.loaded&&"toStoryMode"==this.options.onComplete&&K.setWorldTier()},getLinked:function(){let t=this.options.link;if(!t)return[];let e=[];return K.group.feature[K.mode].everyLayer.eachLayer(function(i){K.has(i.options.id,t)&&e.push(i)}),e}}),L.Layer.include({addClass:function(t){let e,i,s,o,n,l=classesToArray(t),a="marker"===this.options.shape?this.options.icon.options.className:this.options.className;if(l.length&&(e=` ${stripAndCollapse(i=a||"")} `)){for(o=0;s=l[o++];)e.indexOf(` ${s} `)<0&&(e+=s+" ");i!==(n=stripAndCollapse(e))&&this.applySetting({setting:"className",value:n,skipSave:!0})}return this},removeClass:function(t){let e,i,s,o,n,l=classesToArray(t),a="marker"===this.options.shape?this.options.icon.options.className:this.options.className;if(l.length&&(e=` ${stripAndCollapse(i=a||"")} `)){for(o=0;s=l[o++];)for(;e.indexOf(` ${s} `)>-1;)e=e.replace(` ${s} `," ");i!==(n=stripAndCollapse(e))&&this.applySetting({setting:"className",value:n,skipSave:!0})}return this}}),L.Polyline.include({initialize:function(t,e){L.setOptions(this,e),K.in("shape",e)&&K.each(t,(t,e)=>{e.lat=L.Util.formatNum(e.lat),e.lng=L.Util.formatNum(e.lng)}),this._setLatLngs(t)}}),L.Circle.include({initialize:function(t,e,i){if("number"==typeof e&&(e=L.extend({},i,{radius:e})),L.setOptions(this,e),K.in("shape",e)&&(t.lat=L.Util.formatNum(t.lat),t.lng=L.Util.formatNum(t.lng),this.options.radius=L.Util.formatNum(this.options.radius)),this._latlng=L.latLng(t),isNaN(this.options.radius))throw new Error("Circle radius cannot be NaN");this._mRadius=this.options.radius}}),L.Path.include({updateStyle:function(){return this._renderer&&this._renderer._updateStyle(this),this}}),L.Marker.include({initialize:function(t,e){L.setOptions(this,e),K.in("shape",e)&&(t.lat=L.Util.formatNum(t.lat),t.lng=L.Util.formatNum(t.lng)),this._latlng=L.latLng(t),this.options.creator&&this.updateIcon(),this.options.cycle&&K.cycle.add(this)},updateIcon:function(t={}){if(!this.options.icon)return this;const e=this.getSetting("iconUrl");return this.options.icon=createIcon(K.extend({iconUrl:e,iconSize:this.getSetting("iconSize"),html:e?"":this.getSetting("html"),className:this.getSetting("className"),done:!this.options.onComplete&&K.complete.is(this),time:K.complete.time(this),layer:this},t)),this._map&&(this._initIcon(),this.update()),this._popup&&this.bindPopup(this.popup),this}}),L.DivIcon.include({createIcon:function(t){const e=this.options,i=t&&"DIV"===t.tagName?t:document.createElement("div");if(i.innerHTML=K.getSetting(this.options,"html")||this.getIconHTML(),e.bgPos){var s=L.point(e.bgPos);i.style.backgroundPosition=-s.x+"px "+-s.y+"px"}return this._setIconStyles(i,"icon"),i},getIconHTML:function(){const t=this.options;return`${K.getSetting(t,"className").contains("anim-icon")?'<img class="halo" src="images/_a.svg">':""} \n            <img src="${K.getSetting(t,"iconUrl")||""}" class="icon">\n            ${t.done&&!t.time?'<img src="images/complete.svg" class="done">':""}\n            ${t.done&&t.time?`<span class="time">${t.time}</span>`:""}\n            ${K.svg.dot}`.replace(/ {2,}/g," ")}}),L.Icon.include({_setIconStyles:function(t,e){let i,s,o;const n=this.options,l=`${e}Size`,a="className",p=n.layer;p?(o=p.getSetting(l),"number"===K.type(o)&&(o=[o,o]),i=L.point(o),s=L.point("shadow"===e&&n.shadowAnchor||n.iconAnchor||i&&i.divideBy(2,!0)),t[a]=`leaflet-marker-${e} ${p.getSetting(a)||""} ${p.getSetting(a,!0)||""} ${p.getSetting("group")||""}`):(o=n[l],"number"===K.type(o)&&(o=[o,o]),i=L.point(o),s=L.point("shadow"===e&&n.shadowAnchor||n.iconAnchor||i&&i.divideBy(2,!0)),t[a]=`leaflet-marker-${e} ${n[a]||""}`),s&&(t.style.marginLeft=-s.x+"px",t.style.marginTop=-s.y+"px"),i&&(t.style.width=i.x+"px",t.style.height=i.y+"px")}}),L.SVG.include({_initPath:function(t){const e=t._path=L.SVG.create("path"),i=t.options,s=t.getSetting("className");s&&L.DomUtil.addClass(e,s),i.interactive&&L.DomUtil.addClass(e,"leaflet-interactive"),this._updateStyle(t),this._layers[L.stamp(t)]=t},_updateStyle:function(t){const e=t._path,i=t.options,s=t.getSetting("stroke"),o=t.getSetting("color"),n=t.getSetting("opacity"),l=t.getSetting("weight"),a=t.getSetting("fillColor"),p=t.getSetting("fillOpacity");e&&(s?(e.setAttribute("stroke",o),e.setAttribute("stroke-opacity",n),e.setAttribute("stroke-width",l),e.setAttribute("stroke-linecap",i.lineCap),e.setAttribute("stroke-linejoin",i.lineJoin),i.dashArray?e.setAttribute("stroke-dasharray",i.dashArray):e.removeAttribute("stroke-dasharray"),i.dashOffset?e.setAttribute("stroke-dashoffset",i.dashOffset):e.removeAttribute("stroke-dashoffset")):e.setAttribute("stroke","none"),i.fill?(e.setAttribute("fill",a||o),e.setAttribute("fill-opacity",p),e.setAttribute("fill-rule",i.fillRule||"evenodd")):e.setAttribute("fill","none"))}}),L.SVG.include(L.Browser.vml?{_initPath:function(t){const e=t._container=L.SVG.create("shape"),i=t.getSetting("className");L.DomUtil.addClass(e,"leaflet-vml-shape "+(i||"")),e.coordsize="1 1",t._path=L.SVG.create("path"),e.appendChild(t._path),this._updateStyle(t),this._layers[L.stamp(t)]=t},_updateStyle:function(t){var e=t._stroke,i=t._fill;const s=t.options,o=t._container,n=t.getSetting("stroke"),l=t.getSetting("color"),a=t.getSetting("opacity"),p=t.getSetting("weight"),r=t.getSetting("fill"),h=t.getSetting("fillColor"),c=t.getSetting("fillOpacity");o.stroked=!!n,o.filled=!!r,n?(!e&&(e=t._stroke=L.SVG.create("stroke")),o.appendChild(e),e.weight=p+"px",e.color=l,e.opacity=a,s.dashArray?e.dashStyle=L.Util.isArray(s.dashArray)?s.dashArray.join(" "):s.dashArray.replace(/( *, *)/g," "):e.dashStyle="",e.endcap=s.lineCap.replace("butt","flat"),e.joinstyle=s.lineJoin):e&&(o.removeChild(e),t._stroke=null),r?(!i&&(i=t._fill=L.SVG.create("fill")),o.appendChild(i),i.color=h||l,i.opacity=c):i&&(o.removeChild(i),t._fill=null)}}:{}),L.DivOverlay.include({_updateContent:function(){if(this instanceof L.Popup&&this.options.list&&this.options.list.title&&(this._content=this.convertContent(this.options)),!this._content)return;let t=this._contentNode,e="function"==typeof this._content?this._content(this._source||this):this._content;if("string"==typeof e){if("World Tier"==K.mode){let t=new RegExp('<p class="level">.+?</p>');e.bMatch(t)&&(e=e.replace(t,`<p class="level">\n                        Level: <img src="images/mode-world-tier-${K.getWorldTier()}.svg" class="tier">\n                    </p>`)),t=new RegExp("<p.+>Level.+?</p>"),e.bMatch(t)&&(e=e.replace(t,`<p class="description">\n                        Level: <img src="images/mode-world-tier-${K.getWorldTier()}.svg" class="tier">\n                    </p>`))}t.innerHTML=e}else{for(;t.hasChildNodes();)t.removeChild(t.firstChild);t.appendChild(e)}this.fire("contentupdate")}}),L.Popup.include({_updateLayout:function(){let t=this._contentNode,e=t.style,i=t.offsetWidth,s=t.offsetHeight,o="",n=$(`<div>${this._content}</div>`);if(n.children().each(function(){o=` ${o.trim()} ${$(this).text()} `,$(this).remove()}),(o=`${o.trim()} ${$(n).text()}`.trim()).split(/ /).length>2)for(let o=i;o>1;o--)if(e.width=o+"px",t.offsetHeight>s){e.width=o+1+"px";break}e.whiteSpace="",e.height="";var l=this.options.maxHeight;l&&s>l?(e.height=l+"px",L.DomUtil.addClass(t,"leaflet-popup-scrolled")):L.DomUtil.removeClass(t,"leaflet-popup-scrolled"),this._containerWidth=this._container.offsetWidth}}),L.Control.Button=L.Control.extend({options:{position:"topleft",container:"map",text:"",title:"Save all changes",css:"save",clickFn:createGeoJSON},onAdd:function(){let t=this.options,e="leaflet-control "+t.container+" leaflet-bar",i=document.getElementsByClassName(e)[0]||L.DomUtil.create("div",e);return this._button=this._createButton(t.text,t.title,"leaflet-control-"+t.css,i,this._onClick),i},onRemove:function(){},disable:function(){return this._disabled=!0,this._updateDisabled(),this},enable:function(){return this._disabled=!1,this._updateDisabled(),this},_onClick:function(){this._disabled||this.options.clickFn()},_createButton:function(t,e,i,s,o){let n=L.DomUtil.create("a",i,s);return n.innerHTML=t,n.href="#",n.title=e,n.setAttribute("role","button"),n.setAttribute("aria-label",e),L.DomEvent.on(n,"mousedown dblclick",L.DomEvent.stopPropagation).on(n,"click",L.DomEvent.stop).on(n,"click",o,this),n},_updateDisabled:function(){L.DomUtil.removeClass(this._button,"leaflet-disabled"),this._disabled&&L.DomUtil.addClass(this._button,"leaflet-disabled")}}),L.control.button=function(t){return new L.Control.Button(t)};
//# sourceMappingURL=L.Extended.js.map