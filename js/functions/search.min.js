import{jQuery as $}from"../jQuery/jquery3.4.1.js";import{L}from"../Leaflet/importer.js";import{K}from"../K.js";K.search={options:{keys:["creator","type","category","content"]},paths:{creator:"layer.options.creator",type:"layer.options.type",category:"layer.options.category",content:"layer._popup._content"},defaultPath:[[50,50],[51,50]],line:L.polyline([[50,50],[51,50]],{group:"groupAll",weight:2,color:"#724ab1",opacity:.4}),elements:[{key:"NONE",selector:".search .no-results"},{key:"LIST",selector:".search .results"},{key:"SEARCH",selector:"#search",event:"input change paste",action:function(t){const e=$(t).val().trim().replace(/\s{2,}/," ").replace(/:\s+(\w+ )/,":$1");this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(()=>{this.populate(e)},400)}},{key:"CLEAR",selector:"#search-clear",action:function(){this.SEARCH.val("").trigger("change").focus()}},{key:"MORE",selector:".search .more",action:function(){this.display()}},{key:"ITEM",selector:".search .result",call:["detach"]},{key:"COUNT",selector:".search .count"},{key:"SHARE",selector:".search .share",action:function(){K.share(["search"])}},{key:"BTN.CATEGORY",selector:".search .quick .category"},{key:"BTN.TYPE",selector:".search .quick .type"},{key:"BTN.CREATOR",selector:".search .quick .creator"},{key:"BTN.CONTENT",selector:".search .quick .content"},{key:"SORT.CATEGORY.ASC",selector:".search .sort input.category.asc"},{key:"SORT.CATEGORY.DESC",selector:".search .sort input.category.desc"},{key:"SORT.TYPE.ASC",selector:".search .sort input.type.asc"},{key:"SORT.TYPE.DESC",selector:".search .sort input.type.desc"},{key:"SORT.CONTENT.ASC",selector:".search .sort input.content.asc"},{key:"SORT.CONTENT.DESC",selector:".search .sort input.content.desc"},{key:"SORT.DATE.ASC",selector:".search .sort input.date.asc"},{key:"SORT.DATE.DESC",selector:".search .sort input.date.desc"},{key:"SORT.DISTANCE.ASC",selector:".search .sort input.distance.asc"},{key:"SORT.DISTANCE.DESC",selector:".search .sort input.distance.desc"},{key:"CHECK.EXACT",selector:".search .checks input.exact",event:"change",value:K.local("search-exact")||!1,action:function(t){K.local("search-exact",$(t).is(":checked")),this.SEARCH.trigger("change").focus()}},{key:"CHECK.MATCH",selector:".search .checks input.match",event:"change",value:K.local("search-match")||!1,action:function(t){K.local("search-match",$(t).is(":checked")),this.SEARCH.trigger("change").focus()}},{key:"CHECK.PATH",selector:".search .checks input.path",event:"change",value:K.local("search-path")||!1,action:function(t){K.local("search-path",$(t).is(":checked")),$(t).is(":checked")?K.myMap.addLayer(K.search.line):K.myMap.removeLayer(K.search.line)}},{key:"CHECK.ONLY",selector:".search .checks input.only",event:"change",value:K.local("search-only")||!1,action:function(){}},{key:"MENU",selector:".bar-toggle.search"}],list:null,loaded:0,terms:!1,keySearch:!1,timeout:!1,attach:function(){K.group.clearSearch(),K.group.search();const t=this;K.each(this.elements,function(){const e=this.key.split(".");let s=t;for(let i=0,n=e.length;i<n;i++){const c=e[i];if(i!=n-1)!s[c]&&(s[c]={}),s=s[c];else{s[c]=$(this.selector);const e=s[c];if(this.call)for(const t of this.call)e[t]();"boolean"==K.type(this.value)&&e.prop("checked",this.value);const i=this.event||"click",n=this.action;n&&e.off(i).on(i,function(){n.call(t,this)})}}}),K.each(this.BTN,function(){$(this).off("click").on("click",function(){let e=t.SEARCH.val().trim().replace(/\s{2,}/," ").replace(/:\s+(\w+ )/,":$1");const s=$(this).attr("type");if(!e.contains(s)){e=`${e} ${s}:${"creator"==s&&K.user.name?K.user.name:""}`.trim()}t.SEARCH.val(e);const i=e.split(" ");let n=!1,c=-1,a=e.length-1;for(let t=0;t<i.length;t++){const o=i[t];if(o.contains(":")){const t=o.split(":");t[0]==s?""!=t[1]?(n=t[0],a=(c=e.indexOf(s+":"+t[1])+s.length+1)+t[1].length):c=a=e.indexOf(s+":")+s.length+1:n=!1}else n&&(a=a+1+o.length)}t.SEARCH.selectRange(c,a).trigger("change")})});const e=K.local("searchSort")||{btn:"date",dir:"asc"};$(`.search .sort input[btn=${e.btn}][dir=${e.dir}]`).prop("checked",!0),K.each(this.SORT,function(){K.each(this,function(){$(this).off("change").on("change",function(){const e=$(this).is(":checked"),s=".search .sort input";$(s).prop("checked",!1),$(this).prop("checked",e),!$(s+":checked").length&&t.SORT.DATE.ASC.prop("checked",!0),t.trigger();const i=$(s+":checked");K.local("searchSort",{btn:i.attr("btn"),dir:i.attr("dir")})})})}),this.CHECK.PATH.is(":checked")&&K.myMap.addLayer(K.search.line)},results:function(t,e){if(!t)return[];e=this.options=K.extend(this.options,e);const s=this.keySearch={},i=/"(\w[^"]+\w)"/g,n=/['"]\w[^"']+\w["']/g,c=t.match(/(\w+:[^:]{0,}(?= \w+:)|\w+:.{0,}$)/g)||[];t=t.replace(/ ?\w+:.*/g,"").trim();const a=this.terms=t.match(i)||[];K.each(a,(t,e)=>a[t]=e.replace('"',""));let o=(t=t.replace(n,"").replace(/\s{2,}/," ").trim()).split(" ");for(let t=0;t<o.length;t++)o[t]&&a.push(o[t]);for(const t of c){const c=t.split(":"),a=c[0];s[a]={key:a,values:c[1].match(i)||[]},o=c[1].replace(n,"").replace(/\s{2,}/," ").trim(),!e.exactMatch&&(o=o.split(" ")),e.exactMatch&&(o=[o]);for(let t=0;t<o.length;t++)o[t]&&s[a].values.push("type"==a?o[t].space():o[t])}const r=[];return K.each(K.group.search(),function(){let t=!1;this.matches=[];for(const i in s){if(!K.in(i,e.keys))continue;const n=s[i];!K.length(n.values)&&(t=!0);for(let s=0;s<n.values.length;s++){const c=n.values[s]||"ignorer",a=e.matchCase;e.exactMatch&&"content"!=i?!(this[i]||"").equals(c,a)&&(t=!0):!(this[i]||"").contains(c,a)&&(t=!0)}}if(t)return;for(let t in s)this.matches.push(t);let i=!0;if(a.length){i=!1;for(let t=0;t<e.keys.length;t++){const s=e.keys[t];let n=0;for(let t=0;t<a.length;t++){const i=a[t];"string"==K.type(this[s])&&this[s].contains(i,e.matchCase)&&n++}n==a.length&&(i=!0,this.matches.push(s))}}i&&r.push(this)}),r},populate:function(t){$(".pan-pointer").removeClass("pan-pointer");const e={matchCase:this.CHECK.MATCH.is(":checked"),exactMatch:this.CHECK.EXACT.is(":checked"),resultsOnly:this.CHECK.ONLY.is(":checked")};if(this.line.setLatLngs(this.defaultPath),this.list=this.results(t,e),this.sort(),this.loaded=0,!K.length(this.list))return this.LIST.hide(),this.NONE.show(),this.COUNT.html(""),this.SHARE.hide(),void this.line.setLatLngs(this.defaultPath);this.NONE.hide(),this.LIST.show().html(""),this.SHARE.show(),this.LIST.animate({scrollTop:0},400),this.counter.set(this.list.length),this.display()},counter:{set:function(t){this.to=t,this.time&&clearTimeout(this.time),this.action()},time:!1,to:!1,on:0,action:function(){if(this.on==this.to)return;const t=Math.abs(this.to-this.on),e=t>500?50:t>250?25:t>100?10:t>25?5:1;this.to<this.on?this.on-=e:this.on+=e,K.search.COUNT.html(`There ${1==this.on?"is only":"are"} <span class="num">${this.on}</span> result${1==this.on?"":"s"}!`),this.time=setTimeout(()=>{this.action()},3)}},display:function(){const t=this.loaded+50;for(this.MORE.hide();this.loaded<this.list.length;this.loaded++){if(this.loaded==t){this.MORE.show();break}const e=this.list[this.loaded],s=this.ITEM.clone().appendTo(this.LIST),i=e.layer.options.iconUrl;$(".num",s).text(this.loaded+1),i?$(".icon",s).attr("src",i):($(".poly",s).css({backgroundColor:e.layer.options.fillColor,borderColor:e.layer.options.color}),$(".content",s).addClass("poly-info"));for(let t=0;t<this.options.keys.length;t++){const i=this.options.keys[t];let n=K.getPropByString(e,this.paths[i]);$(`.${i}.text`,s).html("type"==i?n.space():n)}K.empty(e.content)&&$(".content.text",s).hide();for(let t=0;t<e.matches.length;t++){const i=e.matches[t],n=$(`.${i}.text`,s);for(let t=0;t<this.terms.length;t++){const e=this.terms[t];n.replaceAll(new RegExp(`(${e})`,`${this.options.matchCase?"":"i"}g`),"<strong>$1</strong>")}const c=this.keySearch[i];if(c)for(let t=0;t<c.values.length;t++){const e=c.values[t];n.replaceAll(new RegExp(`(${e})`,`${this.options.matchCase?"":"i"}g`),"<strong>$1</strong>")}}s.on("click",function(){$(".pan-pointer").removeClass("pan-pointer");const t=K.group.getLayer(e.layer.options.id);let s=t.options.group.replace("group","").replace(/^0/,"");s=(isNaN(s)?9:parseInt(s))+2,t._latlng?(K.myMap.flyTo(e.layer._latlng,s,{maxZoom:15}),K.myMap.once("moveend",()=>{$(t._icon).addClass("pan-pointer")})):K.myMap.flyToBounds(e.layer._latlngs,{animate:!0,padding:L.point([250,250]),maxZoom:15})}),s.show()}},map:!1,sort:function(){if(!K.length(this.list))return;const t={};if($(".search .sort input:checked").each(function(){t[$(this).attr("btn")]=$(this).attr("dir")}),K.in("distance",t)){let t=1,e=[],s=this.list.length;const i=c=>{const a=c.layer._latlng||L.latLngBounds(c.layer._latlngs).getCenter();let o={index:-1,distance:1/0,latLng:[0,0]};if(K.each(this.list,(t,e)=>{if(K.in("distance",e)||c===e)return;const s=e.layer._latlng||L.latLngBounds(e.layer._latlngs).getCenter(),i=a.distanceTo(s)/1e3;i<o.distance&&(o={distance:i,index:t,latLng:s})}),this.list[o.index]){if(e.length>s/4&&o.distance>Math.max.apply(Math,e))return void n(this.list[o.index]);o.distance>5&&t++,e.push(o.distance),this.list[o.index].distance=t,i(this.list[o.index])}},n=s=>{const n=s.layer._latlng||L.latLngBounds(s.layer._latlngs).getCenter(),c={index:-1,distance:1/0};K.each(this.list,(t,e)=>{if(s===e||!K.in("distance",e))return;const i=e.layer._latlng||L.latLngBounds(e.layer._latlngs).getCenter(),a=n.distanceTo(i)/1e3;a<c.distance&&(c.distance=a,c.index=t)});let a,o=1/0;this.list[c.index]&&(t=this.list[c.index].distance-1,e.push(c.distance),t++,s.distance=o=t),K.each(this.list,(e,i)=>{s!==i&&i.distance>=o&&(i.distance++,i.distance>t&&(t=i.distance,a=i))}),a&&i(a)};let c,a=1/0;K.each(this.list,(t,e)=>{const s=(e.layer._latlng||L.latLngBounds(e.layer._latlngs).getCenter()).distanceTo([8.3,-14.9]);s<a&&(a=s,c=t)}),this.list[c].distance=0,i(this.list[c])}this.list.sort((e,s)=>{for(const i in t){const n="asc"==t[i];if(K.empty(e[i]))return 1;if(K.empty(s[i]))return-1;if(n&&e[i]>s[i]||!n&&e[i]<s[i])return 1;if(n&&e[i]<s[i]||!n&&e[i]>s[i])return-1}});const e=[];K.each(this.list,(t,s)=>{e.push(s.layer._latlng||L.latLngBounds(s.layer._latlngs).getCenter())}),this.line.setLatLngs(e)},find:function(t){for(let e=0;e<this.list.length;e++){const s=this.list[e];if(s.layer.options.id==t)return s}},trigger:function(){this.SEARCH.trigger("change")},by:function(t,e){this.MENU.not(".active").trigger("click"),this.SORT.DISTANCE.ASC.prop("checked",!0).trigger("change"),this.CHECK.EXACT.prop("checked",!0),this.CHECK.MATCH.prop("checked",!0),this.SEARCH.val(`${t}:${e.space()}`).trigger("change")}};
//# sourceMappingURL=search.min.js.map