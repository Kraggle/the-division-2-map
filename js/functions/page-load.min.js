import{jQuery as $}from"../jQuery/jquery3.4.1.js";import{L}from"../Leaflet/importer.js";import{K}from"../K.js";import{empty,polyHoverAnimation,toCorrectType,sortObjByKeys,switchLayerGroups,setGridRotate,editIconMessage}from"./misc.js";import{drawEventCreated}from"../extensions/L.Draw.Extended.js";import{keypressEvent}from"./shortcut.js";import{populateMap}from"./populate-map.js";import{populateMenus}from"./populate-menus.js";export default function pageLoad(){K.loaded=!1,K.cycle.reset(),K.group.draw.clearLayers(),"true"==K.urlParam("noIcon")&&K.local("hideIcon",!0),"true"==K.urlParam("clean")&&K.local("cleanMenu",!0),K.local("hideIcon")||$("#survival-logo").fadeIn(500),K.local("cleanMenu")&&($(".bar-toggle.login").hide(0),$(".bar-toggle.filters").hide(0),$(".bar-toggle.full").hide(0),$(".bar-toggle.changes").hide(0),$(".bar-toggle.todo").hide(0),$(".bar-toggle.gear").hide(0),$(".bar-toggle.shorts").hide(0),$(".leaflet-control-attribution.leaflet-control").hide(0),$("#logo").hide(0)),"true"==K.urlParam("overwolf")&&($(".bar-toggle.full").hide(0),$(".bar-toggle.changes").hide(0),$(".bar-toggle.todo").hide(0),$(".bar-toggle.shorts").hide(0),$(".leaflet-control-attribution.leaflet-control").hide(0),$("#alert").hide(0),$("#logo").hide(0)),$.ajax({url:"php/get_markers.php"}).done(function(e){K.each($.parseJSON(e),function(e,a){K.settings.main.iconUrl.values[a.replace("../","")]={shape:[]}})}),K.checkLogin(()=>{!K.user.donate&&!K.urlParam("overwolf")&&$("#alert").show(),K.user.donate&&$("#alert").hide(),$("#message").removeClass("master");let e=$("#side-bar .shorts .box-content");if(e.html(""),$(".bar-toggle.shorts").hide(),K.each(K.bar.b,function(e,a){empty(a)}),empty(K.drawControl),$("document").off("keypress"),$("#side-bar a.login").removeClass("out"),K.user.type){$("#side-bar a.login").addClass("out"),$("#message").addClass("master"),!K.urlParam("overwolf")&&$(".bar-toggle.shorts").show();let a=function(e,a){return`<div class="item">\n                    <div>${e}</div>\n                    <div class="grey">-</div>\n                    <span>${a.replace(" Survival","")}</span>\n                </div>`};e.append('<span class="title">Shortcuts</span>'),K.each(K.shortcuts,function(t,o){e.append(`<span class="title sub">${t.space()}</span>`),K.each(o,function(t,o){e.append(a(t,o.space()))})}),e.append(K.credits),K.bar.b.power=L.control.button({text:"",container:"power",title:"Enable/disable tools",css:"power",clickFn:function(){K.bar.b.power._click()}}).addTo(K.myMap),K.extend(K.bar.b.power,{enabled:function(){return!$(this._button).hasClass("enabled")},_click:function(){let e=$(this._button),a=$(".leaflet-top.leaflet-left").children().not(".power").find("a");this.enabled()||K.check.doOnce?(e.addClass("enabled"),K.each(K.bar.draw,function(e,a){a.disabler()}),$("#marker-tools, .group-switch, #settings-menu").remove(),K.bar.b.group.disable(),K.bar.b.tools.disable(),switchLayerGroups(!0),$(a.get().reverse()).each(function(e,a){setTimeout(function(){$(a).css("transform","translateX(-50px)")},40*e)})):(a.each(function(e,a){setTimeout(function(){$(a).css("transform","translateX(0px)")},40*e)}),e.removeClass("enabled"),K.each(K.bar.draw,function(e,a){a.enabler()}),K.bar.b.group.enable(),K.bar.b.tools.enable(),switchLayerGroups()),K.local("powered",this.enabled()),K.check.doOnce=!1}}),K.bar.b.save=L.control.button().addTo(K.myMap).disable(),K.bar.b.cancel=L.control.button({text:"",title:"Discard all unsaved changes",css:"cancel",clickFn:function(){$("<div />",{class:"screen-blank",html:$("<div />",{class:"confirm",html:$("<div />",{class:"message",html:"Are you sure you want to discard all changes?"})})}).appendTo("body"),$("<a />",{class:"button no",title:"Cancel",html:"Cancel"}).appendTo(".confirm").on("click",function(){$(".screen-blank").remove()}),$("<a />",{class:"button yes",title:"Discard",html:"Discard"}).appendTo(".confirm").on("click",function(){$(".screen-blank").remove(),K.save.clear(),pageLoad()})}}).addTo(K.myMap).disable(),K.bar.b.group=L.control.button({text:"",title:"Switch editable layers",css:"group",clickFn:function(){if($(".group-switch").length)return void $(".group-switch").remove();$("body").append('<div class="leaflet-menu group-switch"></div>');let e=document.getElementsByClassName("group-switch")[0];L.DomEvent.disableClickPropagation(e),L.DomEvent.on(e,"mousewheel",L.DomEvent.stopPropagation),K.each(sortObjByKeys(K.map.type[K.mode]),function(e,a){$(".leaflet-menu").append(`<span class="leaflet-menu-item title">${e.space()}</span>`),K.each(sortObjByKeys(a),function(e){$(".leaflet-menu").append(`<a class="leaflet-menu-item switch-active-group \n                                ${K.map.active[e]?" active":""}" type="${e}">${e.space().replace(" Of "," of ")}</a>`)})}),$(".switch-active-group").on("click",function(){let e=$(this).attr("type");$(this).toggleClass("active"),K.map.active[e]=!K.map.active[e],switchLayerGroups()})}}).addTo(K.myMap),K.bar.b.grid=L.control.button({text:"",title:"Grid modifier tools",css:"grid",clickFn:function(){let e=arguments[0]._button;if($("#slider-box").length)return void $("#slider-box").remove();let a=["rotate","x-pos","y-pos"];$(e).after('<div id="slider-box" class="slider-panel"></div>'),K.each(a,function(e,a){$("#slider-box").append(`<div class="leaflet-menu-slider">\n                            <div id="slider-${a}" class="slider-class ${a}">\n                                <div class="handle-${a} ui-slider-handle"></div>\n                            </div>\n                        </div>`),$("#slider-"+a).slider({min:"rotate"==a?-45:-100,max:"rotate"==a?45:100,step:"rotate"==a?.5:1,value:K.local(`grid-${a}`)||0,create:function(){let e=$(this).slider("value");$(".handle-"+a).text("rotate"==a?e+" deg":"x-pos"==a?"X: "+e:"Y: "+e)},slide:function(e,t){$(".handle-"+a).text("rotate"==a?t.value+" deg":"x-pos"==a?"X: "+t.value:"Y: "+t.value),K.local("grid-"+a,t.value),setGridRotate()},change:function(e,t){$(".handle-"+a).text("rotate"==a?t.value+" deg":"x-pos"==a?"X: "+t.value:"Y: "+t.value),K.local("grid-"+a,t.value),setGridRotate()}})}),$("#slider-box").append('<div class="slider-resets"></div>'),K.each(a,function(e,a){$(".slider-resets").append(`<a class="slider-button reset-${a}">Reset ${a.firstToUpper()}</a>`),$(".slider-button.reset-"+a).on("click",function(){$("#slider-"+a).slider("value",0)})}),$(".slider-resets").append('<a class="slider-button reset-all">Reset All</a>'),$(".slider-button.reset-all").on("click",function(){$(".slider-class").slider("value",0)});let t=L.DomUtil.get("slider-box");L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"mousewheel",L.DomEvent.stopPropagation)}}).addTo(K.myMap).disable(),K.bar.b.tools=L.control.button({text:"",title:"Toggle marker tool panel",css:"tools",clickFn:K.tool.marker.show}).addTo(K.myMap),K.updateMarker(),K.myMap.addControl(K.drawControl).on("draw:created",drawEventCreated),K.bar.draw.Polygon=K.drawControl._toolbars.draw._modes.polygon.handler,K.bar.draw.Polyline=K.drawControl._toolbars.draw._modes.polyline.handler,K.bar.draw.Rectangle=K.drawControl._toolbars.draw._modes.rectangle.handler,K.bar.draw.Marker=K.drawControl._toolbars.draw._modes.marker.handler,K.bar.draw.Circle=K.drawControl._toolbars.draw._modes.circle.handler,K.bar.edit.Edit=K.drawControl._toolbars.edit._modes.edit.handler,K.bar.edit.Remove=K.drawControl._toolbars.edit._modes.remove.handler,$(document).off("keypress"),$(document).on("keypress",keypressEvent),K.myMap.on("draw:editstart",function(){polyHoverAnimation(!0),$("#settings-menu, .group-switch, #marker-tools").remove(),K.bar.b.power.disable(),K.bar.b.group.disable(),K.bar.b.save.disable(),K.bar.b.tools.disable(),K.myMap.addLayer(K.group.draw).addLayer(K.grid.overlay),K.bar.b.grid.enable(),setGridRotate(),K.bar.edit.Remove.disabler(),K.each(K.bar.draw,function(e,a){a.disabler()}),K.check.editing=!0,editIconMessage(),K.group.draw.eachLayer(function(e){e.dragging.enabled()&&(e.dragging.disable(),e.editing.wasDragging=!0)})}),K.myMap.on("draw:edited",function(e){e.layers.eachLayer(function(e){e.saved(!1)})}),K.myMap.on("draw:editstop",function(){K.bar.b.power.enable(),K.bar.b.group.enable(),K.bar.b.tools.enable(),K.save.check(),K.myMap.removeLayer(K.grid.overlay),K.bar.b.grid.disable(),$("#slider-box").remove(),K.bar.edit.Remove.enabler(),K.each(K.bar.draw,function(e,a){a.enabler()}),K.check.editing=!1,polyHoverAnimation(),K.myMap.panBy([0,0]),K.group.draw.eachLayer(function(e){e.editing.wasDragging&&(e.dragging.enable(),e.editing.wasDragging=!1)})}),K.myMap.on("draw:deletestart",function(){K.check.deleting=!0,K.each(K.bar.b,function(e,a){a.disable()}),K.bar.edit.Edit.disabler(),K.each(K.bar.draw,function(e,a){a.disabler()}),K.myMap.addLayer(K.group.draw),setGridRotate()}),K.myMap.on("draw:deleted",function(e){K.each(e.layers._layers,function(e,a){K.group.draw.removeLayer(e),K.save.delete(a),K.map.type.remove(a.options.type)})}),K.myMap.on("draw:deletestop",function(){K.check.deleting=!1,K.bar.b.power.enable(),K.bar.b.group.enable(),K.save.check(),K.bar.edit.Edit.enabler(),K.each(K.bar.draw,function(e,a){a.enabler()}),K.myMap.panBy([0,0])}),K.myMap.on("draw:drawstop",function(){K.user.type>3||K.msg.show({msg:"Remember, you may have to zoom in to see the layers you create!",time:2500})})}K.user.type&&K.check.doOnce&&K.bar.b.power._onClick(),$.ajax({type:"POST",url:"php/file_exists.php",data:{data:K.user.name}}).done(function(e){e=$.parseJSON(e),K.userPath=e?"data/"+K.user.name+"/geoJSON.json":"data/empty.json",$.ajax({type:"POST",url:"php/file_date.php",data:{path:K.userPath}}).done(function(e){e=$.parseJSON(e),$.getJSON(`${K.userPath}?v=${e.date}`,function(e){$.ajax({type:"POST",url:"php/file_date.php",data:{path:"data/geoJSON.json"}}).done(function(a){a=$.parseJSON(a),$.getJSON(`data/geoJSON.json?v=${a.date}`,function(a){K.myMap.invalidateSize(),K.each(K.group.feature,function(e,a){K.each(a,function(e,a){a.clearLayers(),K.myMap.removeLayer(a)})}),K.modes.clear(),K.map.type.counts={},K.complete.layers=[],K.timed.layers=[];const t=K.local("unsaved")||{features:{},settings:{}};K.each(t.features,function(e,a){a.unsaved=!0}),K.each(t.settings,function(e,a){a.unsaved=!0}),e.features&&K.extend(a.features,e.features),K.extend(a.features,t.features),K.layer=K.extend({},a.settings,e.settings||{},t.settings),K.each(K.layer,function(e,a){K.each(a.o,function(a,t){K.layer[e].o[a]=toCorrectType(a,t)})}),K.each(a.features,function(e,a){populateMap(a,e)})}).done(function(){populateMenus(),K.setWorldTier(),K.loaded=!0,setTimeout(()=>K.cycle.start(),1e3),K.search.attach(),K.performURITasks()})})})})})})}
//# sourceMappingURL=page-load.min.js.map