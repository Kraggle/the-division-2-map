import{CodeMirror}from"../../lib/codemirror.js";var Pos=CodeMirror.Pos;function cmp(e,t){return e.line-t.line||e.ch-t.ch}var nameStartChar="A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",nameChar=nameStartChar+"-:.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040",xmlTagStart=new RegExp("<(/?)(["+nameStartChar+"]["+nameChar+"]*)","g");function Iter(e,t,n,r){this.line=t,this.ch=n,this.cm=e,this.text=e.getLine(t),this.min=r?Math.max(r.from,e.firstLine()):e.firstLine(),this.max=r?Math.min(r.to-1,e.lastLine()):e.lastLine()}function tagAt(e,t){var n=e.cm.getTokenTypeAt(Pos(e.line,t));return n&&/\btag\b/.test(n)}function nextLine(e){if(!(e.line>=e.max))return e.ch=0,e.text=e.cm.getLine(++e.line),!0}function prevLine(e){if(!(e.line<=e.min))return e.text=e.cm.getLine(--e.line),e.ch=e.text.length,!0}function toTagEnd(e){for(;;){var t=e.text.indexOf(">",e.ch);if(-1==t){if(nextLine(e))continue;return}if(tagAt(e,t+1)){var n=e.text.lastIndexOf("/",t),r=n>-1&&!/\S/.test(e.text.slice(n+1,t));return e.ch=t+1,r?"selfClose":"regular"}e.ch=t+1}}function toTagStart(e){for(;;){var t=e.ch?e.text.lastIndexOf("<",e.ch-1):-1;if(-1==t){if(prevLine(e))continue;return}if(tagAt(e,t+1)){xmlTagStart.lastIndex=t,e.ch=t;var n=xmlTagStart.exec(e.text);if(n&&n.index==t)return n}else e.ch=t}}function toNextTag(e){for(;;){xmlTagStart.lastIndex=e.ch;var t=xmlTagStart.exec(e.text);if(!t){if(nextLine(e))continue;return}if(tagAt(e,t.index+1))return e.ch=t.index+t[0].length,t;e.ch=t.index+1}}function toPrevTag(e){for(;;){var t=e.ch?e.text.lastIndexOf(">",e.ch-1):-1;if(-1==t){if(prevLine(e))continue;return}if(tagAt(e,t+1)){var n=e.text.lastIndexOf("/",t),r=n>-1&&!/\S/.test(e.text.slice(n+1,t));return e.ch=t+1,r?"selfClose":"regular"}e.ch=t}}function findMatchingClose(e,t){for(var n=[];;){var r,i=toNextTag(e),a=e.line,o=e.ch-(i?i[0].length:0);if(!i||!(r=toTagEnd(e)))return;if("selfClose"!=r)if(i[1]){for(var f=n.length-1;f>=0;--f)if(n[f]==i[2]){n.length=f;break}if(f<0&&(!t||t==i[2]))return{tag:i[2],from:Pos(a,o),to:Pos(e.line,e.ch)}}else n.push(i[2])}}function findMatchingOpen(e,t){for(var n=[];;){var r=toPrevTag(e);if(!r)return;if("selfClose"!=r){var i=e.line,a=e.ch,o=toTagStart(e);if(!o)return;if(o[1])n.push(o[2]);else{for(var f=n.length-1;f>=0;--f)if(n[f]==o[2]){n.length=f;break}if(f<0&&(!t||t==o[2]))return{tag:o[2],from:Pos(e.line,e.ch),to:Pos(i,a)}}}else toTagStart(e)}}CodeMirror.registerHelper("fold","xml",function(e,t){for(var n=new Iter(e,t.line,0);;){var r=toNextTag(n);if(!r||n.line!=t.line)return;var i=toTagEnd(n);if(!i)return;if(!r[1]&&"selfClose"!=i){var a=Pos(n.line,n.ch),o=findMatchingClose(n,r[2]);return o&&cmp(o.from,a)>0?{from:a,to:o.from}:null}}}),CodeMirror.findMatchingTag=function(e,t,n){var r=new Iter(e,t.line,t.ch,n);if(-1!=r.text.indexOf(">")||-1!=r.text.indexOf("<")){var i=toTagEnd(r),a=i&&Pos(r.line,r.ch),o=i&&toTagStart(r);if(i&&o&&!(cmp(r,t)>0)){var f={from:Pos(r.line,r.ch),to:a,tag:o[2]};return"selfClose"==i?{open:f,close:null,at:"open"}:o[1]?{open:findMatchingOpen(r,o[2]),close:f,at:"close"}:{open:f,close:findMatchingClose(r=new Iter(e,a.line,a.ch,n),o[2]),at:"open"}}}},CodeMirror.findEnclosingTag=function(e,t,n,r){for(var i=new Iter(e,t.line,t.ch,n);;){var a=findMatchingOpen(i,r);if(!a)break;var o=findMatchingClose(new Iter(e,t.line,t.ch,n),a.tag);if(o)return{open:a,close:o}}},CodeMirror.scanForClosingTag=function(e,t,n,r){return findMatchingClose(new Iter(e,t.line,t.ch,r?{from:0,to:r}:null),n)};
//# sourceMappingURL=xml-fold.js.map