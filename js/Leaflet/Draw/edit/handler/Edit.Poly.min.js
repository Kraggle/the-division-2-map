L.Edit=L.Edit||{},L.Edit.Poly=L.Handler.extend({options:{},initialize:function(poly,options){this.latlngs=[poly._latlngs],poly._holes&&(this.latlngs=this.latlngs.concat(poly._holes)),this._poly=poly,L.setOptions(this,options),this._poly.on("revert-edited",this._updateLatLngs,this)},_defaultShape:function(){return L.Polyline._flat?L.Polyline._flat(this._poly._latlngs)?this._poly._latlngs:this._poly._latlngs[0]:this._poly._latlngs},_eachVertexHandler:function(callback){for(var i=0;i<this._verticesHandlers.length;i++)callback(this._verticesHandlers[i])},addHooks:function(){this._initHandlers(),this._eachVertexHandler(function(handler){handler.addHooks()})},removeHooks:function(){this._eachVertexHandler(function(handler){handler.removeHooks()})},updateMarkers:function(){this._eachVertexHandler(function(handler){handler.updateMarkers()})},_initHandlers:function(){this._verticesHandlers=[];for(var i=0;i<this.latlngs.length;i++)this._verticesHandlers.push(new L.Edit.PolyVerticesEdit(this._poly,this.latlngs[i],this.options))},_updateLatLngs:function(e){this.latlngs=[e.layer._latlngs],e.layer._holes&&(this.latlngs=this.latlngs.concat(e.layer._holes))}}),L.Edit.PolyVerticesEdit=L.Handler.extend({options:{icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),touchIcon:new L.DivIcon({iconSize:new L.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-touch-icon"}),drawError:{color:"#b00b00",timeout:1e3}},initialize:function(poly,latlngs,options){L.Browser.touch&&(this.options.icon=this.options.touchIcon),this._poly=poly,options&&options.drawError&&(options.drawError=L.Util.extend({},this.options.drawError,options.drawError)),this._latlngs=latlngs,L.setOptions(this,options)},_defaultShape:function(){return L.Polyline._flat?L.Polyline._flat(this._latlngs)?this._latlngs:this._latlngs[0]:this._latlngs},addHooks:function(){var poly=this._poly;poly instanceof L.Polygon||(poly.options.fill=!1,poly.options.editing&&(poly.options.editing.fill=!1)),poly.setStyle(poly.options.editing),this._poly._map&&(this._map=this._poly._map,this._markerGroup||this._initMarkers(),this._poly._map.addLayer(this._markerGroup))},removeHooks:function(){var poly=this._poly;poly.setStyle(poly.options.original),poly._map&&(poly._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers)},updateMarkers:function(){this._markerGroup.clearLayers(),this._initMarkers()},_initMarkers:function(){this._markerGroup||(this._markerGroup=new L.LayerGroup),this._markers=[];var latlngs=this._defaultShape(),i,j,len,marker,markerLeft,markerRight;for(i=0,len=latlngs.length;i<len;i++)(marker=this._createMarker(latlngs[i],i)).on("click",this._onMarkerClick,this),this._markers.push(marker);for(i=0,j=len-1;i<len;j=i++)(0!==i||L.Polygon&&this._poly instanceof L.Polygon)&&(markerLeft=this._markers[j],markerRight=this._markers[i],this._createMiddleMarker(markerLeft,markerRight),this._updatePrevNext(markerLeft,markerRight))},_createMarker:function(latlng,index){var marker=new L.Marker.Touch(latlng,{draggable:!0,icon:this.options.icon});return marker._origLatLng=latlng,marker._index=index,marker.on("dragstart",this._onMarkerDragStart,this).on("drag",this._onMarkerDrag,this).on("dragend",this._fireEdit,this).on("touchmove",this._onTouchMove,this).on("touchend",this._fireEdit,this).on("MSPointerMove",this._onTouchMove,this).on("MSPointerUp",this._fireEdit,this),this._markerGroup.addLayer(marker),marker},_onMarkerDragStart:function(){this._poly.fire("editstart")},_spliceLatLngs:function(){var latlngs=this._defaultShape(),removed=[].splice.apply(latlngs,arguments);return this._poly._convertLatLngs(latlngs,!0),this._poly.redraw(),removed},_removeMarker:function(marker){var i=marker._index;this._markerGroup.removeLayer(marker),this._markers.splice(i,1),this._spliceLatLngs(i,1),this._updateIndexes(i,-1),marker.off("dragstart",this._onMarkerDragStart,this).off("drag",this._onMarkerDrag,this).off("dragend",this._fireEdit,this).off("touchmove",this._onMarkerDrag,this).off("touchend",this._fireEdit,this).off("click",this._onMarkerClick,this).off("MSPointerMove",this._onTouchMove,this).off("MSPointerUp",this._fireEdit,this)},_fireEdit:function(){this._poly.edited=!0,this._poly.fire("edit"),this._poly._map.fire(L.Draw.Event.EDITVERTEX,{layers:this._markerGroup,poly:this._poly})},_onMarkerDrag:function(e){var marker=e.target,poly=this._poly;if(L.extend(marker._origLatLng,marker._latlng),marker._middleLeft&&marker._middleLeft.setLatLng(this._getMiddleLatLng(marker._prev,marker)),marker._middleRight&&marker._middleRight.setLatLng(this._getMiddleLatLng(marker,marker._next)),poly.options.poly){var tooltip=poly._map._editTooltip;if(!poly.options.poly.allowIntersection&&poly.intersects()){var originalColor=poly.options.color;poly.setStyle({color:this.options.drawError.color}),0!==L.version.indexOf("0.7")&&marker.dragging._draggable._onUp(e),this._onMarkerClick(e),tooltip&&tooltip.updateContent({text:L.drawLocal.draw.handlers.polyline.error}),setTimeout(function(){poly.setStyle({color:originalColor}),tooltip&&tooltip.updateContent({text:L.drawLocal.edit.handlers.edit.tooltip.text,subtext:L.drawLocal.edit.handlers.edit.tooltip.subtext})},1e3)}}this._poly.redraw(),this._poly.fire("editdrag")},_onMarkerClick:function(e){var minPoints=L.Polygon&&this._poly instanceof L.Polygon?4:3,marker=e.target;this._defaultShape().length<minPoints||(this._removeMarker(marker),this._updatePrevNext(marker._prev,marker._next),marker._middleLeft&&this._markerGroup.removeLayer(marker._middleLeft),marker._middleRight&&this._markerGroup.removeLayer(marker._middleRight),marker._prev&&marker._next?this._createMiddleMarker(marker._prev,marker._next):marker._prev?marker._next||(marker._prev._middleRight=null):marker._next._middleLeft=null,this._fireEdit())},_onTouchMove:function(e){var layerPoint=this._map.mouseEventToLayerPoint(e.originalEvent.touches[0]),latlng=this._map.layerPointToLatLng(layerPoint),marker=e.target;L.extend(marker._origLatLng,latlng),marker._middleLeft&&marker._middleLeft.setLatLng(this._getMiddleLatLng(marker._prev,marker)),marker._middleRight&&marker._middleRight.setLatLng(this._getMiddleLatLng(marker,marker._next)),this._poly.redraw(),this.updateMarkers()},_updateIndexes:function(index,delta){this._markerGroup.eachLayer(function(marker){marker._index>index&&(marker._index+=delta)})},_createMiddleMarker:function(marker1,marker2){var latlng=this._getMiddleLatLng(marker1,marker2),marker=this._createMarker(latlng),onClick,onDragStart,onDragEnd;marker.setOpacity(.6),marker1._middleRight=marker2._middleLeft=marker,onDragStart=function(){marker.off("touchmove",onDragStart,this);var i=marker2._index;marker._index=i,marker.off("click",onClick,this).on("click",this._onMarkerClick,this),latlng.lat=marker.getLatLng().lat,latlng.lng=marker.getLatLng().lng,this._spliceLatLngs(i,0,latlng),this._markers.splice(i,0,marker),marker.setOpacity(1),this._updateIndexes(i,1),marker2._index++,this._updatePrevNext(marker1,marker),this._updatePrevNext(marker,marker2),this._poly.fire("editstart")},onDragEnd=function(){marker.off("dragstart",onDragStart,this),marker.off("dragend",onDragEnd,this),marker.off("touchmove",onDragStart,this),this._createMiddleMarker(marker1,marker),this._createMiddleMarker(marker,marker2)},onClick=function(){onDragStart.call(this),onDragEnd.call(this),this._fireEdit()},marker.on("click",onClick,this).on("dragstart",onDragStart,this).on("dragend",onDragEnd,this).on("touchmove",onDragStart,this),this._markerGroup.addLayer(marker)},_updatePrevNext:function(marker1,marker2){marker1&&(marker1._next=marker2),marker2&&(marker2._prev=marker1)},_getMiddleLatLng:function(marker1,marker2){var map=this._poly._map,p1=map.project(marker1.getLatLng()),p2=map.project(marker2.getLatLng());return map.unproject(p1._add(p2)._divideBy(2))}}),L.Polyline.addInitHook(function(){this.editing||(L.Edit.Poly&&(this.editing=new L.Edit.Poly(this,this.options.poly),this.options.editable&&this.editing.enable()),this.on("add",function(){this.editing&&this.editing.enabled()&&this.editing.addHooks()}),this.on("remove",function(){this.editing&&this.editing.enabled()&&this.editing.removeHooks()}))});
//# sourceMappingURL=Edit.Poly.min.js.map