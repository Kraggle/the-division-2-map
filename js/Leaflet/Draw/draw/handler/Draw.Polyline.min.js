L.Draw.Polyline=L.Draw.Feature.extend({statics:{TYPE:"polyline"},Poly:L.Polyline,options:{allowIntersection:!0,repeatMode:!1,drawError:{color:"#b00b00",timeout:2500},icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),touchIcon:new L.DivIcon({iconSize:new L.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-touch-icon"}),guidelineDistance:20,maxGuideLineLength:4e3,shapeOptions:{stroke:!0,color:"#3388ff",weight:4,opacity:.5,fill:!1,clickable:!0},metric:!0,feet:!0,nautic:!1,showLength:!0,zIndexOffset:2e3},initialize:function(map,options){L.Browser.touch&&(this.options.icon=this.options.touchIcon),this.options.drawError.message=L.drawLocal.draw.handlers.polyline.error,options&&options.drawError&&(options.drawError=L.Util.extend({},this.options.drawError,options.drawError)),this.type=L.Draw.Polyline.TYPE,L.Draw.Feature.prototype.initialize.call(this,map,options)},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this),this._map&&(this._markers=[],this._markerGroup=new L.LayerGroup,this._map.addLayer(this._markerGroup),this._poly=new L.Polyline([],this.options.shapeOptions),this._tooltip.updateContent(this._getTooltipText()),this._mouseMarker||(this._mouseMarker=L.marker(this._map.getCenter(),{icon:L.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})),this._mouseMarker.on("mouseout",this._onMouseOut,this).on("mousemove",this._onMouseMove,this).on("mousedown",this._onMouseDown,this).on("mouseup",this._onMouseUp,this).addTo(this._map),this._map.on("mouseup",this._onMouseUp,this).on("mousemove",this._onMouseMove,this).on("zoomlevelschange",this._onZoomEnd,this).on("touchstart",this._onTouch,this).on("zoomend",this._onZoomEnd,this))},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this),this._clearHideErrorTimeout(),this._cleanUpShape(),this._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers,this._map.removeLayer(this._poly),delete this._poly,this._mouseMarker.off("mousedown",this._onMouseDown,this).off("mouseout",this._onMouseOut,this).off("mouseup",this._onMouseUp,this).off("mousemove",this._onMouseMove,this),this._map.removeLayer(this._mouseMarker),delete this._mouseMarker,this._clearGuides(),this._map.off("mouseup",this._onMouseUp,this).off("mousemove",this._onMouseMove,this).off("zoomlevelschange",this._onZoomEnd,this).off("zoomend",this._onZoomEnd,this).off("touchstart",this._onTouch,this).off("click",this._onTouch,this)},deleteLastVertex:function(){if(!(this._markers.length<=1)){var lastMarker=this._markers.pop(),poly=this._poly,latlngs=poly.getLatLngs(),latlng=latlngs.splice(-1,1)[0];this._poly.setLatLngs(latlngs),this._markerGroup.removeLayer(lastMarker),poly.getLatLngs().length<2&&this._map.removeLayer(poly),this._vertexChanged(latlng,!1)}},addVertex:function(latlng){var markersLength;this._markers.length>=2&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(latlng)?this._showErrorTooltip():(this._errorShown&&this._hideErrorTooltip(),this._markers.push(this._createMarker(latlng)),this._poly.addLatLng(latlng),2===this._poly.getLatLngs().length&&this._map.addLayer(this._poly),this._vertexChanged(latlng,!0))},completeShape:function(){this._markers.length<=1||(this._fireCreatedEvent(),this.disable(),this.options.repeatMode&&this.enable())},_finishShape:function(){var latlngs=this._poly._defaultShape?this._poly._defaultShape():this._poly.getLatLngs(),intersects=this._poly.newLatLngIntersects(latlngs[latlngs.length-1]);!this.options.allowIntersection&&intersects||!this._shapeIsValid()?this._showErrorTooltip():(this._fireCreatedEvent(),this.disable(),this.options.repeatMode&&this.enable())},_shapeIsValid:function(){return!0},_onZoomEnd:function(){null!==this._markers&&this._updateGuide()},_onMouseMove:function(e){var newPos=this._map.mouseEventToLayerPoint(e.originalEvent),latlng=this._map.layerPointToLatLng(newPos);this._currentLatLng=latlng,this._updateTooltip(latlng),this._updateGuide(newPos),this._mouseMarker.setLatLng(latlng),L.DomEvent.preventDefault(e.originalEvent)},_vertexChanged:function(latlng,added){this._map.fire(L.Draw.Event.DRAWVERTEX,{layers:this._markerGroup}),this._updateFinishHandler(),this._updateRunningMeasure(latlng,added),this._clearGuides(),this._updateTooltip()},_onMouseDown:function(e){if(!this._clickHandled&&!this._touchHandled&&!this._disableMarkers){this._onMouseMove(e),this._clickHandled=!0,this._disableNewMarkers();var originalEvent=e.originalEvent,clientX=originalEvent.clientX,clientY=originalEvent.clientY;this._startPoint.call(this,clientX,clientY)}},_startPoint:function(clientX,clientY){this._mouseDownOrigin=L.point(clientX,clientY)},_onMouseUp:function(e){var originalEvent=e.originalEvent,clientX=originalEvent.clientX,clientY=originalEvent.clientY;this._endPoint.call(this,clientX,clientY,e),this._clickHandled=null},_endPoint:function(clientX,clientY,e){if(this._mouseDownOrigin){var dragCheckDistance=L.point(clientX,clientY).distanceTo(this._mouseDownOrigin),lastPtDistance;this._calculateFinishDistance(e.latlng)<10&&L.Browser.touch?this._finishShape():Math.abs(dragCheckDistance)<9*(window.devicePixelRatio||1)&&this.addVertex(e.latlng),this._enableNewMarkers()}this._mouseDownOrigin=null},_onTouch:function(e){var originalEvent=e.originalEvent,clientX,clientY;!originalEvent.touches||!originalEvent.touches[0]||this._clickHandled||this._touchHandled||this._disableMarkers||(clientX=originalEvent.touches[0].clientX,clientY=originalEvent.touches[0].clientY,this._disableNewMarkers(),this._touchHandled=!0,this._startPoint.call(this,clientX,clientY),this._endPoint.call(this,clientX,clientY,e),this._touchHandled=null),this._clickHandled=null},_onMouseOut:function(){this._tooltip&&this._tooltip._onMouseOut.call(this._tooltip)},_calculateFinishDistance:function(potentialLatLng){var lastPtDistance;if(this._markers.length>0){var finishMarker;if(this.type===L.Draw.Polyline.TYPE)finishMarker=this._markers[this._markers.length-1];else{if(this.type!==L.Draw.Polygon.TYPE)return 1/0;finishMarker=this._markers[0]}var lastMarkerPoint=this._map.latLngToContainerPoint(finishMarker.getLatLng()),potentialMarker=new L.Marker(potentialLatLng,{icon:this.options.icon,zIndexOffset:2*this.options.zIndexOffset}),potentialMarkerPint=this._map.latLngToContainerPoint(potentialMarker.getLatLng());lastPtDistance=lastMarkerPoint.distanceTo(potentialMarkerPint)}else lastPtDistance=1/0;return lastPtDistance},_updateFinishHandler:function(){var markerCount=this._markers.length;markerCount>1&&this._markers[markerCount-1].on("click",this._finishShape,this),markerCount>2&&this._markers[markerCount-2].off("click",this._finishShape,this)},_createMarker:function(latlng){var marker=new L.Marker(latlng,{icon:this.options.icon,zIndexOffset:2*this.options.zIndexOffset});return this._markerGroup.addLayer(marker),marker},_updateGuide:function(newPos){var markerCount=this._markers?this._markers.length:0;markerCount>0&&(newPos=newPos||this._map.latLngToLayerPoint(this._currentLatLng),this._clearGuides(),this._drawGuide(this._map.latLngToLayerPoint(this._markers[markerCount-1].getLatLng()),newPos))},_updateTooltip:function(latLng){var text=this._getTooltipText();latLng&&this._tooltip.updatePosition(latLng),this._errorShown||this._tooltip.updateContent(text)},_drawGuide:function(pointA,pointB){var length=Math.floor(Math.sqrt(Math.pow(pointB.x-pointA.x,2)+Math.pow(pointB.y-pointA.y,2))),guidelineDistance=this.options.guidelineDistance,maxGuideLineLength=this.options.maxGuideLineLength,i=length>maxGuideLineLength?length-maxGuideLineLength:guidelineDistance,fraction,dashPoint,dash;for(this._guidesContainer||(this._guidesContainer=L.DomUtil.create("div","leaflet-draw-guides",this._overlayPane));i<length;i+=this.options.guidelineDistance)fraction=i/length,dashPoint={x:Math.floor(pointA.x*(1-fraction)+fraction*pointB.x),y:Math.floor(pointA.y*(1-fraction)+fraction*pointB.y)},(dash=L.DomUtil.create("div","leaflet-draw-guide-dash",this._guidesContainer)).style.backgroundColor=this._errorShown?this.options.drawError.color:this.options.shapeOptions.color,L.DomUtil.setPosition(dash,dashPoint)},_updateGuideColor:function(color){if(this._guidesContainer)for(var i=0,l=this._guidesContainer.childNodes.length;i<l;i++)this._guidesContainer.childNodes[i].style.backgroundColor=color},_clearGuides:function(){if(this._guidesContainer)for(;this._guidesContainer.firstChild;)this._guidesContainer.removeChild(this._guidesContainer.firstChild)},_getTooltipText:function(){var showLength=this.options.showLength,labelText,distanceStr;return L.Browser.touch&&(showLength=!1),0===this._markers.length?labelText={text:L.drawLocal.draw.handlers.polyline.tooltip.start}:(distanceStr=showLength?this._getMeasurementString():"",labelText=1===this._markers.length?{text:L.drawLocal.draw.handlers.polyline.tooltip.cont,subtext:distanceStr}:{text:L.drawLocal.draw.handlers.polyline.tooltip.end,subtext:distanceStr}),labelText},_updateRunningMeasure:function(latlng,added){var markersLength=this._markers.length,previousMarkerIndex,distance;1===this._markers.length?this._measurementRunningTotal=0:(previousMarkerIndex=markersLength-(added?2:1),distance=latlng.distanceTo(this._markers[previousMarkerIndex].getLatLng()),this._measurementRunningTotal+=distance*(added?1:-1))},_getMeasurementString:function(){var currentLatLng=this._currentLatLng,previousLatLng=this._markers[this._markers.length-1].getLatLng(),distance;return distance=this._measurementRunningTotal+currentLatLng.distanceTo(previousLatLng),L.GeometryUtil.readableDistance(distance,this.options.metric,this.options.feet,this.options.nautic)},_showErrorTooltip:function(){this._errorShown=!0,this._tooltip.showAsError().updateContent({text:this.options.drawError.message}),this._updateGuideColor(this.options.drawError.color),this._poly.setStyle({color:this.options.drawError.color}),this._clearHideErrorTimeout(),this._hideErrorTimeout=setTimeout(L.Util.bind(this._hideErrorTooltip,this),this.options.drawError.timeout)},_hideErrorTooltip:function(){this._errorShown=!1,this._clearHideErrorTimeout(),this._tooltip.removeError().updateContent(this._getTooltipText()),this._updateGuideColor(this.options.shapeOptions.color),this._poly.setStyle({color:this.options.shapeOptions.color})},_clearHideErrorTimeout:function(){this._hideErrorTimeout&&(clearTimeout(this._hideErrorTimeout),this._hideErrorTimeout=null)},_disableNewMarkers:function(){this._disableMarkers=!0},_enableNewMarkers:function(){setTimeout(function(){this._disableMarkers=!1}.bind(this),50)},_cleanUpShape:function(){this._markers.length>1&&this._markers[this._markers.length-1].off("click",this._finishShape,this)},_fireCreatedEvent:function(){var poly=new this.Poly(this._poly.getLatLngs(),this.options.shapeOptions);L.Draw.Feature.prototype._fireCreatedEvent.call(this,poly)}});
//# sourceMappingURL=Draw.Polyline.min.js.map